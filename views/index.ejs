<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/index.css">
    <link rel="icon" type="image/x-icon" href="/cards/logo.png">
    <title>Uno</title>
  </head>
  <body>
    <h1 id="title">Crazy 8's Uno</h1>

    <div id="topSection">
      <div id="otherPlayers"></div>
      <img id="currentCard" src="" class="topCard" />
      <img id="backCard" class="topCard" src="/cards/back.png">
      <div id="colorPicker" class="hide">
        <button id="chooseRed" class="red">red</button>
        <button id="chooseBlue" class="blue">blue</button>
        <button id="chooseGreen" class="green">green</button>
        <button id="chooseYellow" class="yellow">yellow</button>
      </div>
    </div>
    <div id="cardList">

    </div>
    <script src="http://192.168.1.14:3000/socket.io/socket.io.js"></script>
    <script>
      console.log(window.location.pathname);
      var socket = io();
      var cid;
      var number = -1;
      var backCard = document.getElementById("backCard");
      backCard.addEventListener('click', function(e){
        socket.emit('takeCard', number);
      });

      var colorPicker = document.getElementById('colorPicker');
      for(var i = 0; i < colorPicker.childNodes.length; i ++){
        colorPicker.childNodes[i].addEventListener('click', function(){
          socket.emit('selectedColor', this.id.slice(6).toLowerCase());
          colorPicker.classList.add('hide');
        });
      }
      var topCard = document.getElementById("currentCard");

      socket.on('pickColor', function(num){
        if(number == num){
          document.getElementById('colorPicker').classList.remove('hide');
        }
      });
      socket.on('number', function(num){
        if(number == -1)
          number = num;
      });
      socket.on('cardList', function(players){
        loadCards(players[number]); 
        loadOtherPlayers(players);    
      });
      socket.on('currentCard', function(cid){
        showCurrentCard(cid);    
      });
      socket.on('reset', function(){
        reset();
      });
      function loadOtherPlayers(players){
        document.getElementById('otherPlayers').innerHTML = ' ';
        for(var i = 0; i < players.length; i ++){
          if(i != number){
            var d = document.createElement('div');
            var p = document.createElement('h1');
            p.innerHTML = i + ' <br><br> ' + players[i].length;
            var img = document.createElement('img');
            img.src = '/cards/altback.png';
            d.appendChild(p);
            d.appendChild(img);
            d.classList.add('stack');
            document.getElementById('otherPlayers').appendChild(d);

          }
        }
      }
      function showCurrentColor(c){
        document.getElementById('topSection').classList.remove('red', 'green', 'blue', 'yellow');
        document.getElementById('topSection').classList.add(c);
      }
      function reset(){
        document.getElementById('cardList').innerHTML = ' ';
      }
      function showCurrentCard(c){
        if(c.type == 'normal')
          cid = c.color + '' + c.number;
        else if(c.type == '+4' || c.type == 'color')
          cid = c.type;
        else
          cid = c.color + c.type;
        topCard.src = '/cards/' + cid + '.png';
        topCard.id = cid;
        showCurrentColor(c.color);
      }
      function loadCards(cards){
        reset();
        for (var i = 0; i < cards.length; i ++){
          var c = cards[i];
          if(c.type == 'normal')
            cid = c.color + c.number;
          else if(c.type == '+4' || c.type == 'color')
            cid = c.type;
          else
            cid = c.color + c.type;
          var card = document.createElement("img");
          card.src = '/cards/' + cid + '.png';
          card.id = cid;
          card.classList.add('card');
          document.getElementById('cardList').appendChild(card);
          card.addEventListener('click', function(e){
            socket.emit('cardClicked', this.id, number);
          });
        }
      }
    </script>
  </body>
</html>